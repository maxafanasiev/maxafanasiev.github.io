<!DOCTYPE html>
<html>
  <head>
    <title>Telegram Mini App</title>
    <meta charset="UTF-8" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      .user-info, .server-response {
        background: #f3f3f3;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
      }
      .navigate-button {
        margin-top: 20px;
        display: block;
        padding: 12px 20px;
        background-color: #0088cc;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        text-align: center;
        cursor: pointer;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <h2>Telegram User Info</h2>
    <div class="user-info" id="user-info">Loading...</div>

    <button id="nav-button" class="navigate-button">Enrich User Info with Google</button>

    <script>
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();

      const user = Telegram.WebApp.initDataUnsafe.user || {};

      const telegram_id = user.id;
      const payload = {
        id: telegram_id,
        first_name: user.first_name || "",
        last_name: user.last_name || "",
        username: user.username || "",
        language_code: user.language_code || ""
      };

      const infoBox = document.getElementById("user-info");
      infoBox.innerHTML = `
        <p><strong>ID:</strong> ${payload.id}</p>
        <p><strong>First name:</strong> ${payload.first_name}</p>
        <p><strong>Last name:</strong> ${payload.last_name}</p>
        <p><strong>Username:</strong> @${payload.username}</p>
        <p><strong>Language:</strong> ${payload.language_code}</p>
      `;

      const responseBox = document.getElementById("server-response");

      fetch("https://readily-special-grouper.ngrok-free.app/user", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
        .then((res) => res.json())
        .then((data) => {
          responseBox.textContent = JSON.stringify(data, null, 2);
        })
        .catch((err) => {
          responseBox.textContent = "Error: " + err.message;
          console.error("Error sending user info:", err);
        });

      const navButton = document.getElementById("nav-button");
      const baseUrl = "https://readily-special-grouper.ngrok-free.app/auth/google";
      const oauthUrl = `${baseUrl}?telegram_id=${telegram_id}`;

      navButton.addEventListener("click", () => {
        Telegram.WebApp.openLink(oauthUrl);
      });
    </script>
  </body>
</html>
